//#include <stdio.h>
#include "il2212.h"
#include <string.h>

uint8_t img[3072];
#define dimY 32
#define dimX2 16
#define dimY2 16
#define dimX3 96
#define HMAX HMAX_4
#define HMIN HMIN_4
#define STATE CPU4_STATE
#define IMAGE_CACHE IMAGE_CACHE_1
#define RESULT_IMAGE CPU4_RESULT
//int sqr[] = {0,1,4,9,16,25,36,49,64,81,100,121,144,169,196,225,256,289,324,361,400,441,484,529,576,625,676,729,784,841,900,961,1024,1089,1156,1225,1296,1369,1444,1521,1600,1681,1764,1849,1936,2025,2116,2209,2304,2401,2500,2601,2704,2809,2916,3025,3136,3249,3364,3481,3600,3721,3844,3969,4096,4225,4356,4489,4624,4761,4900,5041,5184,5329,5476,5625,5776,5929,6084,6241,6400,6561,6724,6889,7056,7225,7396,7569,7744,7921,8100,8281,8464,8649,8836,9025,9216,9409,9604,9801,10000,10201,10404,10609,10816,11025,11236,11449,11664,11881,12100,12321,12544,12769,12996,13225,13456,13689,13924,14161,14400,14641,14884,15129,15376,15625,15876,16129,16384,16641,16900,17161,17424,17689,17956,18225,18496,18769,19044,19321,19600,19881,20164,20449,20736,21025,21316,21609,21904,22201,22500,22801,23104,23409,23716,24025,24336,24649,24964,25281,25600,25921,26244,26569,26896,27225,27556,27889,28224,28561,28900,29241,29584,29929,30276,30625,30976,31329,31684,32041,32400,32761,33124,33489,33856,34225,34596,34969,35344,35721,36100,36481,36864,37249,37636,38025,38416,38809,39204,39601,40000,40401,40804,41209,41616,42025,42436,42849,43264,43681,44100,44521,44944,45369,45796,46225,46656,47089,47524,47961,48400,48841,49284,49729,50176,50625,51076,51529,51984,52441,52900,53361,53824,54289,54756,55225,55696,56169,56644,57121,57600,58081,58564,59049,59536,60025,60516,61009,61504,62001,62500,63001,63504,64009,64516,65025,65536,66049,66564,67081,67600,68121,68644,69169,69696,70225,70756,71289,71824,72361,72900,73441,73984,74529,75076,75625,76176,76729,77284,77841,78400,78961,79524,80089,80656,81225,81796,82369,82944,83521,84100,84681,85264,85849,86436,87025,87616,88209,88804,89401,90000,90601,91204,91809,92416,93025,93636,94249,94864,95481,96100,96721,97344,97969,98596,99225,99856,100489,101124,101761,102400,103041,103684,104329,104976,105625,106276,106929,107584,108241,108900,109561,110224,110889,111556,112225,112896,113569,114244,114921,115600,116281,116964,117649,118336,119025,119716,120409,121104,121801,122500,123201,123904,124609,125316,126025,126736,127449,128164,128881,129600,130321,131044,131769,132496,133225,133956,134689,135424,136161,136900,137641,138384,139129,139876,140625,141376,142129,142884,143641,144400,145161,145924,146689,147456,148225,148996,149769,150544,151321,152100,152881,153664,154449,155236,156025,156816,157609,158404,159201,160000,160801,161604,162409,163216,164025,164836,165649,166464,167281,168100,168921,169744,170569,171396,172225,173056,173889,174724,175561,176400,177241,178084,178929,179776,180625,181476,182329,183184,184041,184900,185761,186624,187489,188356,189225,190096,190969,191844,192721,193600,194481,195364,196249,197136,198025,198916,199809,200704,201601,202500,203401,204304,205209,206116,207025,207936,208849,209764,210681,211600,212521,213444,214369,215296,216225,217156,218089,219024,219961,220900,221841,222784,223729,224676,225625,226576,227529,228484,229441,230400,231361,232324,233289,234256,235225,236196,237169,238144,239121,240100,241081,242064,243049,244036,245025,246016,247009,248004,249001,250000,251001,252004,253009,254016,255025,256036,257049,258064,259081,260100,261121,262144,263169,264196,265225,266256,267289,268324,269361,270400,271441,272484,273529,274576,275625,276676,277729,278784,279841,280900,281961,283024,284089,285156,286225,287296,288369,289444,290521,291600,292681,293764,294849,295936,297025,298116,299209,300304,301401,302500,303601,304704,305809,306916,308025,309136,310249,311364,312481,313600,314721,315844,316969,318096,319225,320356,321489,322624,323761,324900,326041,327184,328329,329476,330625,331776,332929,334084,335241,336400,337561,338724,339889,341056,342225,343396,344569,345744,346921,348100,349281,350464,351649,352836,354025,355216,356409,357604,358801,360000,361201,362404,363609,364816,366025,367236,368449,369664,370881,372100,373321,374544,375769,376996,378225,379456,380689,381924,383161,384400,385641,386884,388129,389376,390625,391876,393129,394384,395641,396900,398161,399424,400689,401956,403225,404496,405769,407044,408321,409600,410881,412164,413449,414736,416025,417316,418609,419904,421201,422500,423801,425104,426409,427716,429025,430336,431649,432964,434281,435600,436921,438244,439569,440896,442225,443556,444889,446224,447561,448900,450241,451584,452929,454276,455625,456976,458329,459684,461041,462400,463761,465124,466489,467856,469225,470596,471969,473344,474721,476100,477481,478864,480249,481636,483025,484416,485809,487204,488601,490000,491401,492804,494209,495616,497025,498436,499849,501264,502681,504100,505521,506944,508369,509796,511225,512656,514089,515524,516961,518400,519841,521284,522729,524176,525625,527076,528529,529984,531441,532900,534361,535824,537289,538756,540225,541696,543169,544644,546121,547600,549081,550564,552049,553536,555025,556516,558009,559504,561001,562500,564001,565504,567009,568516,570025,571536,573049,574564,576081,577600,579121,580644,582169,583696,585225,586756,588289,589824,591361,592900,594441,595984,597529,599076,600625,602176,603729,605284,606841,608400,609961,611524,613089,614656,616225,617796,619369,620944,622521,624100,625681,627264,628849,630436,632025,633616,635209,636804,638401,640000,641601,643204,644809,646416,648025,649636,651249,652864,654481,656100,657721,659344,660969,662596,664225,665856,667489,669124,670761,672400,674041,675684,677329,678976,680625,682276,683929,685584,687241,688900,690561,692224,693889,695556,697225,698896,700569,702244,703921,705600,707281,708964,710649,712336,714025,715716,717409,719104,720801,722500,724201,725904,727609,729316,731025,732736,734449,736164,737881,739600,741321,743044,744769,746496,748225,749956,751689,753424,755161,756900,758641,760384,762129,763876,765625,767376,769129,770884,772641,774400,776161,777924,779689,781456,783225,784996,786769,788544,790321,792100,793881,795664,797449,799236,801025,802816,804609,806404,808201,810000,811801,813604,815409,817216,819025,820836,822649,824464,826281,828100,829921,831744,833569,835396,837225,839056,840889,842724,844561,846400,848241,850084,851929,853776,855625,857476,859329,861184,863041,864900,866761,868624,870489,872356,874225,876096,877969,879844,881721,883600,885481,887364,889249,891136,893025,894916,896809,898704,900601,902500,904401,906304,908209,910116,912025,913936,915849,917764,919681,921600,923521,925444,927369,929296,931225,933156,935089,937024,938961,940900,942841,944784,946729,948676,950625,952576,954529,956484,958441,960400,962361,964324,966289,968256,970225,972196,974169,976144,978121,980100,982081,984064,986049,988036,990025,992016,994009,996004,998001,1000000,1002001,1004004,1006009,1008016,1010025,1012036,1014049,1016064,1018081,1020100,1022121,1024144,1026169,1028196,1030225,1032256,1034289,1036324,1038361};
//uint16_t mul2[] = {0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,30,30,30,30,30,30,30,30,31,31,31,31,31,31,31,31,32,32,32,32,32,32,32,32,33,33,33,33,33,33,33,33,34,34,34,34,34,34,34,34,35,35,35,35,35,35,35,35,36,36,36,36,36,36,36,36,37,37,37,37,37,37,37,37,38,38,38,38,38,38,38,38,39,39,39,39,39,39,39,39,40,40,40,40,40,40,40,40,41,41,41,41,41,41,41,41,42,42,42,42,42,42,42,42,43,43,43,43,43,43,43,43,44,44,44,44,44,44,44,44,45,45,45,45,45,45,45,45,46,46,46,46,46,46,46,46,47,47,47,47,47,47,47,47,48,48,48,48,48,48,48,48,49,49,49,49,49,49,49,49,50,50,50,50,50,50,50,50,51,51,51,51,51,51,51,51,52,52,52,52,52,52,52,52,53,53,53,53,53,53,53,53,54,54,54,54,54,54,54,54,55,55,55,55,55,55,55,55,56,56,56,56,56,56,56,56,57,57,57,57,57,57,57,57,58,58,58,58,58,58,58,58,59,59,59,59,59,59,59,59,60,60,60,60,60,60,60,60,61,61,61,61,61,61,61,61,62,62,62,62,62,62,62,62,63,63,63,63,63,63,63,63,64,64,64,64,64,64,64,64,65,65,65,65,65,65,65,65,66,66,66,66,66,66,66,66,67,67,67,67,67,67,67,67,68,68,68,68,68,68,68,68,69,69,69,69,69,69,69,69,70,70,70,70,70,70,70,70,71,71,71,71,71,71,71,71,72,72,72,72,72,72,72,72,73,73,73,73,73,73,73,73,74,74,74,74,74,74,74,74,75,75,75,75,75,75,75,75,76,76,76,76,76,76,76,76,77,77,77,77,77,77,77,77,78,78,78,78,78,78,78,78,79,79,79,79,79,79,79,79,80,80,80,80,80,80,80,80,81,81,81,81,81,81,81,81,82,82,82,82,82,82,82,82,83,83,83,83,83,83,83,83,84,84,84,84,84,84,84,84,85,85,85,85,85,85,85,85,86,86,86,86,86,86,86,86,87,87,87,87,87,87,87,87,88,88,88,88,88,88,88,88,89,89,89,89,89,89,89,89,90,90,90,90,90,90,90,90,91,91,91,91,91,91,91,91,92,92,92,92,92,92,92,92,93,93,93,93,93,93,93,93,94,94,94,94,94,94,94,94,95,95,95,95,95,95,95,95,96,96,96,96,96,96,96,96,97,97,97,97,97,97,97,97,98,98,98,98,98,98,98,98,99,99,99,99,99,99,99,99,100,100,100,100,100,100,100,100,101,101,101,101,101,101,101,101,102,102,102,102,102,102,102,102,103,103,103,103,103,103,103,103,104,104,104,104,104,104,104,104,105,105,105,105,105,105,105,105,106,106,106,106,106,106,106,106,107,107,107,107,107,107,107,107,108,108,108,108,108,108,108,108,109,109,109,109,109,109,109,109,110,110,110,110,110,110,110,110,111,111,111,111,111,111,111,111,112,112,112,112,112,112,112,112,113,113,113,113,113,113,113,113,114,114,114,114,114,114,114,114,115,115,115,115,115,115,115,115,116,116,116,116,116,116,116,116,117,117,117,117,117,117,117,117,118,118,118,118,118,118,118,118,119,119,119,119,119,119,119,119,120,120,120,120,120,120,120,120,121,121,121,121,121,121,121,121,122,122,122,122,122,122,122,122,123,123,123,123,123,123,123,123,124,124,124,124,124,124,124,124,125,125,125,125,125,125,125,125,126,126,126,126,126,126,126,126,127,127,127,127,127,127,127,127};
//uint16_t mul5[] = {0,0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,5,6,6,6,7,7,7,8,8,8,9,9,9,10,10,10,10,11,11,11,12,12,12,13,13,13,14,14,14,15,15,15,15,16,16,16,17,17,17,18,18,18,19,19,19,20,20,20,20,21,21,21,22,22,22,23,23,23,24,24,24,25,25,25,25,26,26,26,27,27,27,28,28,28,29,29,29,30,30,30,30,31,31,31,32,32,32,33,33,33,34,34,34,35,35,35,35,36,36,36,37,37,37,38,38,38,39,39,39,40,40,40,40,41,41,41,42,42,42,43,43,43,44,44,44,45,45,45,45,46,46,46,47,47,47,48,48,48,49,49,49,50,50,50,50,51,51,51,52,52,52,53,53,53,54,54,54,55,55,55,55,56,56,56,57,57,57,58,58,58,59,59,59,60,60,60,60,61,61,61,62,62,62,63,63,63,64,64,64,65,65,65,65,66,66,66,67,67,67,68,68,68,69,69,69,70,70,70,70,71,71,71,72,72,72,73,73,73,74,74,74,75,75,75,75,76,76,76,77,77,77,78,78,78,79,79,79,80,80,80,80,81,81,81,82,82,82,83,83,83,84,84,84,85,85,85,85,86,86,86,87,87,87,88,88,88,89,89,89,90,90,90,90,91,91,91,92,92,92,93,93,93,94,94,94,95,95,95,95,96,96,96,97,97,97,98,98,98,99,99,99,100,100,100,100,101,101,101,102,102,102,103,103,103,104,104,104,105,105,105,105,106,106,106,107,107,107,108,108,108,109,109,109,110,110,110,110,111,111,111,112,112,112,113,113,113,114,114,114,115,115,115,115,116,116,116,117,117,117,118,118,118,119,119,119,120,120,120,120,121,121,121,122,122,122,123,123,123,124,124,124,125,125,125,125,126,126,126,127,127,127,128,128,128,129,129,129,130,130,130,130,131,131,131,132,132,132,133,133,133,134,134,134,135,135,135,135,136,136,136,137,137,137,138,138,138,139,139,139,140,140,140,140,141,141,141,142,142,142,143,143,143,144,144,144,145,145,145,145,146,146,146,147,147,147,148,148,148,149,149,149,150,150,150,150,151,151,151,152,152,152,153,153,153,154,154,154,155,155,155,155,156,156,156,157,157,157,158,158,158,159,159,159,160,160,160,160,161,161,161,162,162,162,163,163,163,164,164,164,165,165,165,165,166,166,166,167,167,167,168,168,168,169,169,169,170,170,170,170,171,171,171,172,172,172,173,173,173,174,174,174,175,175,175,175,176,176,176,177,177,177,178,178,178,179,179,179,180,180,180,180,181,181,181,182,182,182,183,183,183,184,184,184,185,185,185,185,186,186,186,187,187,187,188,188,188,189,189,189,190,190,190,190,191,191,191,192,192,192,193,193,193,194,194,194,195,195,195,195,196,196,196,197,197,197,198,198,198,199,199,199,200,200,200,200,201,201,201,202,202,202,203,203,203,204,204,204,205,205,205,205,206,206,206,207,207,207,208,208,208,209,209,209,210,210,210,210,211,211,211,212,212,212,213,213,213,214,214,214,215,215,215,215,216,216,216,217,217,217,218,218,218,219,219,219,220,220,220,220,221,221,221,222,222,222,223,223,223,224,224,224,225,225,225,225,226,226,226,227,227,227,228,228,228,229,229,229,230,230,230,230,231,231,231,232,232,232,233,233,233,234,234,234,235,235,235,235,236,236,236,237,237,237,238,238,238,239,239,239,240,240,240,240,241,241,241,242,242,242,243,243,243,244,244,244,245,245,245,245,246,246,246,247,247,247,248,248,248,249,249,249,250,250,250,250,251,251,251,252,252,252,253,253,253,254,254,254,255,255,255,255,256,256,256,257,257,257,258,258,258,259,259,259,260,260,260,260,261,261,261,262,262,262,263,263,263,264,264,264,265,265,265,265,266,266,266,267,267,267,268,268,268,269,269,269,270,270,270,270,271,271,271,272,272,272,273,273,273,274,274,274,275,275,275,275,276,276,276,277,277,277,278,278,278,279,279,279,280,280,280,280,281,281,281,282,282,282,283,283,283,284,284,284,285,285,285,285,286,286,286,287,287,287,288,288,288,289,289,289,290,290,290,290,291,291,291,292,292,292,293,293,293,294,294,294,295,295,295,295,296,296,296,297,297,297,298,298,298,299,299,299,300,300,300,300,301,301,301,302,302,302,303,303,303,304,304,304,305,305,305,305,306,306,306,307,307,307,308,308,308,309,309,309,310,310,310,310,311,311,311,312,312,312,313,313,313,314,314,314,315,315,315,315,316,316,316,317,317,317,318,318,318,319,319,319};
//uint16_t mul9[] = {0,0,1,1,2,2,3,3,4,5,5,6,6,7,7,8,9,9,10,10,11,11,12,12,13,14,14,15,15,16,16,17,18,18,19,19,20,20,21,21,22,23,23,24,24,25,25,26,27,27,28,28,29,29,30,30,31,32,32,33,33,34,34,35,36,36,37,37,38,38,39,39,40,41,41,42,42,43,43,44,45,45,46,46,47,47,48,48,49,50,50,51,51,52,52,53,54,54,55,55,56,56,57,57,58,59,59,60,60,61,61,62,63,63,64,64,65,65,66,66,67,68,68,69,69,70,70,71,72,72,73,73,74,74,75,75,76,77,77,78,78,79,79,80,81,81,82,82,83,83,84,84,85,86,86,87,87,88,88,89,90,90,91,91,92,92,93,93,94,95,95,96,96,97,97,98,99,99,100,100,101,101,102,102,103,104,104,105,105,106,106,107,108,108,109,109,110,110,111,111,112,113,113,114,114,115,115,116,117,117,118,118,119,119,120,120,121,122,122,123,123,124,124,125,126,126,127,127,128,128,129,129,130,131,131,132,132,133,133,134,135,135,136,136,137,137,138,138,139,140,140,141,141,142,142,143,144,144,145,145,146,146,147,147,148,149,149,150,150,151,151,152,153,153,154,154,155,155,156,156,157,158,158,159,159,160,160,161,162,162,163,163,164,164,165,165,166,167,167,168,168,169,169,170,171,171,172,172,173,173,174,174,175,176,176,177,177,178,178,179,180,180,181,181,182,182,183,183,184,185,185,186,186,187,187,188,189,189,190,190,191,191,192,192,193,194,194,195,195,196,196,197,198,198,199,199,200,200,201,201,202,203,203,204,204,205,205,206,207,207,208,208,209,209,210,210,211,212,212,213,213,214,214,215,216,216,217,217,218,218,219,219,220,221,221,222,222,223,223,224,225,225,226,226,227,227,228,228,229,230,230,231,231,232,232,233,234,234,235,235,236,236,237,237,238,239,239,240,240,241,241,242,243,243,244,244,245,245,246,246,247,248,248,249,249,250,250,251,252,252,253,253,254,254,255,255,256,257,257,258,258,259,259,260,261,261,262,262,263,263,264,264,265,266,266,267,267,268,268,269,270,270,271,271,272,272,273,273,274,275,275,276,276,277,277,278,279,279,280,280,281,281,282,282,283,284,284,285,285,286,286,287,288,288,289,289,290,290,291,291,292,293,293,294,294,295,295,296,297,297,298,298,299,299,300,300,301,302,302,303,303,304,304,305,306,306,307,307,308,308,309,309,310,311,311,312,312,313,313,314,315,315,316,316,317,317,318,318,319,320,320,321,321,322,322,323,324,324,325,325,326,326,327,327,328,329,329,330,330,331,331,332,333,333,334,334,335,335,336,336,337,338,338,339,339,340,340,341,342,342,343,343,344,344,345,345,346,347,347,348,348,349,349,350,351,351,352,352,353,353,354,354,355,356,356,357,357,358,358,359,360,360,361,361,362,362,363,363,364,365,365,366,366,367,367,368,369,369,370,370,371,371,372,372,373,374,374,375,375,376,376,377,378,378,379,379,380,380,381,381,382,383,383,384,384,385,385,386,387,387,388,388,389,389,390,390,391,392,392,393,393,394,394,395,396,396,397,397,398,398,399,399,400,401,401,402,402,403,403,404,405,405,406,406,407,407,408,408,409,410,410,411,411,412,412,413,414,414,415,415,416,416,417,417,418,419,419,420,420,421,421,422,423,423,424,424,425,425,426,426,427,428,428,429,429,430,430,431,432,432,433,433,434,434,435,435,436,437,437,438,438,439,439,440,441,441,442,442,443,443,444,444,445,446,446,447,447,448,448,449,450,450,451,451,452,452,453,453,454,455,455,456,456,457,457,458,459,459,460,460,461,461,462,462,463,464,464,465,465,466,466,467,468,468,469,469,470,470,471,471,472,473,473,474,474,475,475,476,477,477,478,478,479,479,480,480,481,482,482,483,483,484,484,485,486,486,487,487,488,488,489,489,490,491,491,492,492,493,493,494,495,495,496,496,497,497,498,498,499,500,500,501,501,502,502,503,504,504,505,505,506,506,507,507,508,509,509,510,510,511,511,512,513,513,514,514,515,515,516,516,517,518,518,519,519,520,520,521,522,522,523,523,524,524,525,525,526,527,527,528,528,529,529,530,531,531,532,532,533,533,534,534,535,536,536,537,537,538,538,539,540,540,541,541,542,542,543,543,544,545,545,546,546,547,547,548,549,549,550,550,551,551,552,552,553,554,554,555,555,556,556,557,558,558,559,559,560,560,561,561,562,563,563,564,564,565,565,566,567,567,568,568,569,569,570,570,571,572,572,573,573,574,574,575};
const int sqrt17[] = {0,4624,18496,41616,73984,115600,166464,226576,295936,374544,462400,559504,665856,781456,906304,1040400};
char asciiChars[] = {' ','.',':','-','=','+','/','t','z','U','w','*','0','#','%','@'};

void test_printint(int m){
    alt_putchar(m/1000+'0');
    alt_putchar(m/100%10+'0');
    alt_putchar(m/10%10+'0');
    alt_putchar(m%10+'0');
    alt_putchar('\n');
}

void grayAndResizeAndBrightnessSDF(){
    uint8_t i, j;
    int l = 0, m = 0;
    HMAX = 0;
    HMIN = 255;
    int t=0;
    for (j = 0; j < dimY2; j++) {
        for (i = 0; i < dimX2; i++, l+=6, m++){
            t = 5*((img[l] + img[l + 3] + img[l + dimX3] + img[l + dimX3 + 3]))/16;
            t += 9*((img[l + 1] + img[l + 4] + img[l + dimX3 + 1] + img[l + dimX3 + 4]))/16;
            t += 2*((img[l + 2] + img[l + 5] + img[l + dimX3 + 2] + img[l + dimX3 + 5]))/16;
            img[m] = t >> 2;
            if (img[m] > HMAX) HMAX = img[m];
            if (img[m] < HMIN) HMIN = img[m];
        }
        l += dimX3;
    }
}

void correctSDF(uint8_t average){
    if( average < 128){
        int i, scale;
        scale = HMAX - HMIN;
        if (scale > 127) return;
        if (scale > 63) scale = 1;
        else if (scale > 31) scale = 2;
        else if (scale > 15) scale = 3;
        else scale = 4;
        for (i = 0; i < 256; i++){
            img[i] = (img[i] - HMIN)<<scale;
        }
    }else{
    }
}

// returns sqrt(gx^2 + gy^2)/4/17 -> [0,15]
int fastsqrtdiv4_16(int gx, int gy){
    //sqrt[a] = (a*4*17)^2
    
    gx = abs(gx);
    gy = abs(gy);
    if(gx > 1019 || gy > 1019)
        return 15;
    //int x = sqr[gx] + sqr[gy];
    int x = SQR_TABLE[gx] + SQR_TABLE[gy];
    if (x < sqrt17[1]) return 0;
    if (x >= sqrt17[15]) return 15;

    int start;
    if (x > sqrt17[8]){
        if (x > sqrt17[11])start = 12;
        else start = 9;
    }else{
        if (x > sqrt17[5])start = 6;
        else start = 2;
    }
    while(1){
        if (x > sqrt17[start])start ++;
        else return start-1;
    }
}

void sobelSDF(){
    uint8_t* result = RESULT_IMAGE;
    int gx = 0, gy = 0, res = 0, cur = dimX2 - 2;
    int i, j;
    for (i = 1; i < dimY2 - 1; i ++){
        cur += 2;
        for (j = 1; j < dimX2 - 1; j++){
            cur ++;
            gx = 0;
            gx -=   img[ cur - dimX2 - 1 ];
            gx +=   img[ cur - dimX2 + 1 ];
            gx -=   img[ cur        - 1 ]<<1;
            gx +=   img[ cur        + 1 ]<<1;
            gx -=   img[ cur + dimX2 - 1 ];
            gx +=   img[ cur + dimX2 + 1 ];
            gx=abs(gx)-1;
            gy = 0;
            gy -=   img[ cur - dimX2 - 1 ];
            gy -=   img[ cur - dimX2     ]<<1;
            gy -=   img[ cur - dimX2 + 1 ];
            gy +=   img[ cur + dimX2 - 1 ];
            gy +=   img[ cur + dimX2     ]<<1;
            gy +=   img[ cur + dimX2 + 1 ];
            gy=abs(gy)-1;
            
            res = fastsqrtdiv4_16(gx,gy);
            result[(i-1)*(dimX2-2) + j-1] = res;
        }
    }
}

int main() {

    delay(1000);
    STATE = 0;

    // main loop
    while(1){

        //wait for task
        while(STATE != 1) delayabit();
        //image ready

        memcpy(img, IMAGE_CACHE, 3072);
        STATE = 2;

        //start gray
        grayAndResizeAndBrightnessSDF();

        int i,j;
        //run ok
        STATE = 3;

        //wait for task
        while(STATE != 4) delayabit();

        // moore cpu4 - always use cpu1~3
        int avg = (HMAX_1 + HMAX_2 + HMAX_3 - HMIN_1 - HMIN_2 - HMIN_3) / 3;
        correctSDF(avg);
        sobelSDF();
        STATE = 5;
    }
    return 0;
}