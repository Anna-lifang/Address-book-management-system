#include <stdio.h>
#include "images-32x32.h"
#include <stdint.h>
#include <string.h>
#include <stdlib.h>
#include "ascii_gray.h"
#include "system.h"
#include "includes.h"
#define abs(x) (((x)<0)?(-(x)):(x))
#ifdef NOINFO
#define D(x)
#else
#define D(x) x 
#endif

#include <system.h>
#include <sys/alt_timestamp.h>
alt_u32 time[2]={0,0};
void start_timer(){
    if (alt_timestamp_start() < 0) printf("No timestamp device.");
    time[0] = alt_timestamp();
}
void get_time(){
    time[1] += alt_timestamp() - time[0];
}


#define HW_TIMER_PERIOD 100 /*100ms*/

/*definition of Task Stacks */
#define   TASK_STACKSIZE       8192
OS_STK    graySDF2_stk[TASK_STACKSIZE];
OS_STK    resizeSDF2_stk[TASK_STACKSIZE];
OS_STK    brightnessSig_stk[TASK_STACKSIZE];
OS_STK    correctSDF_stk[TASK_STACKSIZE];
OS_STK    sobelSDF_stk[TASK_STACKSIZE];


/*Definition of  task  priority */
#define graySDF2_PRIO           1
#define resizeSDF2_PRIO         2
#define brightnessSig_PRIO      3
#define correctSDF_PRIO         4
#define sobelSDF_PRIO           5

// Semaphores
OS_EVENT *graySDF2Sem;
OS_EVENT *resizeSDF2Sem;
OS_EVENT *brightnessSigSem;
OS_EVENT *correctSDFSem;
OS_EVENT *sobelSDFSem;

void graySDF2(void*);
void resizeSDF2(void*);
void brightnessSig(void*);
void correctSDF(void*);
void sobelSDF(void*);

uint8_t* img;
uint8_t result[30*30];
uint8_t hmaxmin[2];
int correctAvg = 255, correctSum = 0;
int currentImg = 0;
typedef struct{
    int dimX;
    int dimY;
} DIM;
INT8U err;

int fastsqrtdiv4(int gx, int gy){
    const int sqrt[] = {0,16,64,144,256,400,576,784,1024,1296,1600,1936,2304,2704,3136,3600,4096,4624,5184,5776,6400,7056,7744,8464,9216,10000,10816,11664,12544,13456,14400,15376,16384,17424,18496,19600,20736,21904,23104,24336,25600,26896,28224,29584,30976,32400,33856,35344,36864,38416,40000,41616,43264,44944,46656,48400,50176,51984,53824,55696,57600,59536,61504,63504,65536,67600,69696,71824,73984,76176,78400,80656,82944,85264,87616,90000,92416,94864,97344,99856,102400,104976,107584,110224,112896,115600,118336,121104,123904,126736,129600,132496,135424,138384,141376,144400,147456,150544,153664,156816,160000,163216,166464,169744,173056,176400,179776,183184,186624,190096,193600,197136,200704,204304,207936,211600,215296,219024,222784,226576,230400,234256,238144,242064,246016,250000,254016,258064,262144,266256,270400,274576,278784,283024,287296,291600,295936,300304,304704,309136,313600,318096,322624,327184,331776,336400,341056,345744,350464,355216,360000,364816,369664,374544,379456,384400,389376,394384,399424,404496,409600,414736,419904,425104,430336,435600,440896,446224,451584,456976,462400,467856,473344,478864,484416,490000,495616,501264,506944,512656,518400,524176,529984,535824,541696,547600,553536,559504,565504,571536,577600,583696,589824,595984,602176,608400,614656,620944,627264,633616,640000,646416,652864,659344,665856,672400,678976,685584,692224,698896,705600,712336,719104,725904,732736,739600,746496,753424,760384,767376,774400,781456,788544,795664,802816,810000,817216,824464,831744,839056,846400,853776,861184,868624,876096,883600,891136,898704,906304,913936,921600,929296,937024,944784,952576,960400,968256,976144,984064,992016,1000000,1008016,1016064,1024144,1032256,1040400};
    const int sqr[] = {0,1,4,9,16,25,36,49,64,81,100,121,144,169,196,225,256,289,324,361,400,441,484,529,576,625,676,729,784,841,900,961,1024,1089,1156,1225,1296,1369,1444,1521,1600,1681,1764,1849,1936,2025,2116,2209,2304,2401,2500,2601,2704,2809,2916,3025,3136,3249,3364,3481,3600,3721,3844,3969,4096,4225,4356,4489,4624,4761,4900,5041,5184,5329,5476,5625,5776,5929,6084,6241,6400,6561,6724,6889,7056,7225,7396,7569,7744,7921,8100,8281,8464,8649,8836,9025,9216,9409,9604,9801,10000,10201,10404,10609,10816,11025,11236,11449,11664,11881,12100,12321,12544,12769,12996,13225,13456,13689,13924,14161,14400,14641,14884,15129,15376,15625,15876,16129,16384,16641,16900,17161,17424,17689,17956,18225,18496,18769,19044,19321,19600,19881,20164,20449,20736,21025,21316,21609,21904,22201,22500,22801,23104,23409,23716,24025,24336,24649,24964,25281,25600,25921,26244,26569,26896,27225,27556,27889,28224,28561,28900,29241,29584,29929,30276,30625,30976,31329,31684,32041,32400,32761,33124,33489,33856,34225,34596,34969,35344,35721,36100,36481,36864,37249,37636,38025,38416,38809,39204,39601,40000,40401,40804,41209,41616,42025,42436,42849,43264,43681,44100,44521,44944,45369,45796,46225,46656,47089,47524,47961,48400,48841,49284,49729,50176,50625,51076,51529,51984,52441,52900,53361,53824,54289,54756,55225,55696,56169,56644,57121,57600,58081,58564,59049,59536,60025,60516,61009,61504,62001,62500,63001,63504,64009,64516,65025,65536,66049,66564,67081,67600,68121,68644,69169,69696,70225,70756,71289,71824,72361,72900,73441,73984,74529,75076,75625,76176,76729,77284,77841,78400,78961,79524,80089,80656,81225,81796,82369,82944,83521,84100,84681,85264,85849,86436,87025,87616,88209,88804,89401,90000,90601,91204,91809,92416,93025,93636,94249,94864,95481,96100,96721,97344,97969,98596,99225,99856,100489,101124,101761,102400,103041,103684,104329,104976,105625,106276,106929,107584,108241,108900,109561,110224,110889,111556,112225,112896,113569,114244,114921,115600,116281,116964,117649,118336,119025,119716,120409,121104,121801,122500,123201,123904,124609,125316,126025,126736,127449,128164,128881,129600,130321,131044,131769,132496,133225,133956,134689,135424,136161,136900,137641,138384,139129,139876,140625,141376,142129,142884,143641,144400,145161,145924,146689,147456,148225,148996,149769,150544,151321,152100,152881,153664,154449,155236,156025,156816,157609,158404,159201,160000,160801,161604,162409,163216,164025,164836,165649,166464,167281,168100,168921,169744,170569,171396,172225,173056,173889,174724,175561,176400,177241,178084,178929,179776,180625,181476,182329,183184,184041,184900,185761,186624,187489,188356,189225,190096,190969,191844,192721,193600,194481,195364,196249,197136,198025,198916,199809,200704,201601,202500,203401,204304,205209,206116,207025,207936,208849,209764,210681,211600,212521,213444,214369,215296,216225,217156,218089,219024,219961,220900,221841,222784,223729,224676,225625,226576,227529,228484,229441,230400,231361,232324,233289,234256,235225,236196,237169,238144,239121,240100,241081,242064,243049,244036,245025,246016,247009,248004,249001,250000,251001,252004,253009,254016,255025,256036,257049,258064,259081,260100,261121,262144,263169,264196,265225,266256,267289,268324,269361,270400,271441,272484,273529,274576,275625,276676,277729,278784,279841,280900,281961,283024,284089,285156,286225,287296,288369,289444,290521,291600,292681,293764,294849,295936,297025,298116,299209,300304,301401,302500,303601,304704,305809,306916,308025,309136,310249,311364,312481,313600,314721,315844,316969,318096,319225,320356,321489,322624,323761,324900,326041,327184,328329,329476,330625,331776,332929,334084,335241,336400,337561,338724,339889,341056,342225,343396,344569,345744,346921,348100,349281,350464,351649,352836,354025,355216,356409,357604,358801,360000,361201,362404,363609,364816,366025,367236,368449,369664,370881,372100,373321,374544,375769,376996,378225,379456,380689,381924,383161,384400,385641,386884,388129,389376,390625,391876,393129,394384,395641,396900,398161,399424,400689,401956,403225,404496,405769,407044,408321,409600,410881,412164,413449,414736,416025,417316,418609,419904,421201,422500,423801,425104,426409,427716,429025,430336,431649,432964,434281,435600,436921,438244,439569,440896,442225,443556,444889,446224,447561,448900,450241,451584,452929,454276,455625,456976,458329,459684,461041,462400,463761,465124,466489,467856,469225,470596,471969,473344,474721,476100,477481,478864,480249,481636,483025,484416,485809,487204,488601,490000,491401,492804,494209,495616,497025,498436,499849,501264,502681,504100,505521,506944,508369,509796,511225,512656,514089,515524,516961,518400,519841,521284,522729,524176,525625,527076,528529,529984,531441,532900,534361,535824,537289,538756,540225,541696,543169,544644,546121,547600,549081,550564,552049,553536,555025,556516,558009,559504,561001,562500,564001,565504,567009,568516,570025,571536,573049,574564,576081,577600,579121,580644,582169,583696,585225,586756,588289,589824,591361,592900,594441,595984,597529,599076,600625,602176,603729,605284,606841,608400,609961,611524,613089,614656,616225,617796,619369,620944,622521,624100,625681,627264,628849,630436,632025,633616,635209,636804,638401,640000,641601,643204,644809,646416,648025,649636,651249,652864,654481,656100,657721,659344,660969,662596,664225,665856,667489,669124,670761,672400,674041,675684,677329,678976,680625,682276,683929,685584,687241,688900,690561,692224,693889,695556,697225,698896,700569,702244,703921,705600,707281,708964,710649,712336,714025,715716,717409,719104,720801,722500,724201,725904,727609,729316,731025,732736,734449,736164,737881,739600,741321,743044,744769,746496,748225,749956,751689,753424,755161,756900,758641,760384,762129,763876,765625,767376,769129,770884,772641,774400,776161,777924,779689,781456,783225,784996,786769,788544,790321,792100,793881,795664,797449,799236,801025,802816,804609,806404,808201,810000,811801,813604,815409,817216,819025,820836,822649,824464,826281,828100,829921,831744,833569,835396,837225,839056,840889,842724,844561,846400,848241,850084,851929,853776,855625,857476,859329,861184,863041,864900,866761,868624,870489,872356,874225,876096,877969,879844,881721,883600,885481,887364,889249,891136,893025,894916,896809,898704,900601,902500,904401,906304,908209,910116,912025,913936,915849,917764,919681,921600,923521,925444,927369,929296,931225,933156,935089,937024,938961,940900,942841,944784,946729,948676,950625,952576,954529,956484,958441,960400,962361,964324,966289,968256,970225,972196,974169,976144,978121,980100,982081,984064,986049,988036,990025,992016,994009,996004,998001,1000000,1002001,1004004,1006009,1008016,1010025,1012036,1014049,1016064,1018081,1020100,1022121,1024144,1026169,1028196,1030225,1032256,1034289,1036324,1038361};
    gx = abs(gx);
    gy = abs(gy);
    if(gx > 1019 || gy > 1019)return 255;
    if(gx < 2) return gy>>2;
    if(gy < 2) return gx>>2;
    int x = sqr[gx] + sqr[gy];
    if (x < 16) return 0;
    if (x >= sqrt[255]) return 255;
    int start = 1, end = 254;
    while(start < end){
        int mid = (start+end)/2;
        if (sqrt[mid] > x){
            end = mid - 1;
        }else if (sqrt[mid] < x){
            start = mid + 1;
        }else{
            return mid;
        }
    }
    return start-1;
}

void graySDF2(void* p){

    int dim = *(int*)p;
    // may be faster
    const uint16_t mul2[256] = {0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168,170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,206,208,210,212,214,216,218,220,222,224,226,228,230,232,234,236,238,240,242,244,246,248,250,252,254,256,258,260,262,264,266,268,270,272,274,276,278,280,282,284,286,288,290,292,294,296,298,300,302,304,306,308,310,312,314,316,318,320,322,324,326,328,330,332,334,336,338,340,342,344,346,348,350,352,354,356,358,360,362,364,366,368,370,372,374,376,378,380,382,384,386,388,390,392,394,396,398,400,402,404,406,408,410,412,414,416,418,420,422,424,426,428,430,432,434,436,438,440,442,444,446,448,450,452,454,456,458,460,462,464,466,468,470,472,474,476,478,480,482,484,486,488,490,492,494,496,498,500,502,504,506,508,510};
    const uint16_t mul5[256] = {0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,260,265,270,275,280,285,290,295,300,305,310,315,320,325,330,335,340,345,350,355,360,365,370,375,380,385,390,395,400,405,410,415,420,425,430,435,440,445,450,455,460,465,470,475,480,485,490,495,500,505,510,515,520,525,530,535,540,545,550,555,560,565,570,575,580,585,590,595,600,605,610,615,620,625,630,635,640,645,650,655,660,665,670,675,680,685,690,695,700,705,710,715,720,725,730,735,740,745,750,755,760,765,770,775,780,785,790,795,800,805,810,815,820,825,830,835,840,845,850,855,860,865,870,875,880,885,890,895,900,905,910,915,920,925,930,935,940,945,950,955,960,965,970,975,980,985,990,995,1000,1005,1010,1015,1020,1025,1030,1035,1040,1045,1050,1055,1060,1065,1070,1075,1080,1085,1090,1095,1100,1105,1110,1115,1120,1125,1130,1135,1140,1145,1150,1155,1160,1165,1170,1175,1180,1185,1190,1195,1200,1205,1210,1215,1220,1225,1230,1235,1240,1245,1250,1255,1260,1265,1270,1275};
    const uint16_t mul9[256] = {0,9,18,27,36,45,54,63,72,81,90,99,108,117,126,135,144,153,162,171,180,189,198,207,216,225,234,243,252,261,270,279,288,297,306,315,324,333,342,351,360,369,378,387,396,405,414,423,432,441,450,459,468,477,486,495,504,513,522,531,540,549,558,567,576,585,594,603,612,621,630,639,648,657,666,675,684,693,702,711,720,729,738,747,756,765,774,783,792,801,810,819,828,837,846,855,864,873,882,891,900,909,918,927,936,945,954,963,972,981,990,999,1008,1017,1026,1035,1044,1053,1062,1071,1080,1089,1098,1107,1116,1125,1134,1143,1152,1161,1170,1179,1188,1197,1206,1215,1224,1233,1242,1251,1260,1269,1278,1287,1296,1305,1314,1323,1332,1341,1350,1359,1368,1377,1386,1395,1404,1413,1422,1431,1440,1449,1458,1467,1476,1485,1494,1503,1512,1521,1530,1539,1548,1557,1566,1575,1584,1593,1602,1611,1620,1629,1638,1647,1656,1665,1674,1683,1692,1701,1710,1719,1728,1737,1746,1755,1764,1773,1782,1791,1800,1809,1818,1827,1836,1845,1854,1863,1872,1881,1890,1899,1908,1917,1926,1935,1944,1953,1962,1971,1980,1989,1998,2007,2016,2025,2034,2043,2052,2061,2070,2079,2088,2097,2106,2115,2124,2133,2142,2151,2160,2169,2178,2187,2196,2205,2214,2223,2232,2241,2250,2259,2268,2277,2286,2295};

    while(1){
        //printf("graySDF2 pending\n");
	    OSSemPend(graySDF2Sem, 0, &err);
        //printf("graySDF2 run dim = %d\n",dim);
        img = image_sequence[currentImg];
        if (++currentImg > sequence_length){
            double times = (double)(time[1]) * 1000 / alt_timestamp_freq();
            printf("Total time = %3.3g ms, %d imgs, avg t=%3.3g ms\n", times, sequence_length, times/sequence_length);
            while(1);
        }
        start_timer();
        img += 3;
        int i = 0, j = 0, t;
        for (; i < dim; i++){
            t = mul5[img[j++]];
            t+= mul9[img[j++]];
            t+= mul2[img[j++]];
            img[i] = t >> 4;
        }
        //printf("graySDF2 post\n");
        OSSemPost(resizeSDF2Sem);
        //printf("graySDF2 after post\n");
    }
}

void resizeSDF2(void* p){

    DIM* dim = (DIM*)p;
    int dimX = dim->dimX;
    int dimY = dim->dimY;

    while(1){
        //printf("resizeSDF2Sem pending\n");
	    OSSemPend(resizeSDF2Sem, 0, &err);
        //printf("resizeSDF2Sem run\n");
        int i, j, k = 0, l = 0;
        for (j = 0; j < dimY >> 1; j++) {
            for (i = 0; i < dimX >> 1; i++, l++){
                img[l] = (img[l*2 + k] + img[l*2 + k + 1] + img[l*2 + k + dimX] + img[l*2 + k + dimX + 1]) >> 2;
            }
            k += dimX;
        }
        OSSemPost(brightnessSigSem);
    }
}

void brightnessSig(void* p){
    int i;
    int dim = *(int*)p;
    while(1){
        //printf("brightnessSigSem pending\n");
	    OSSemPend(brightnessSigSem, 0, &err);
        //printf("brightnessSigSem run\n");
        hmaxmin[0] = 0;
        hmaxmin[1] = 255;
        for (i = 0; i < dim; i++){
            if (img[i] > hmaxmin[0]) hmaxmin[0] = img[i];
            if (img[i] < hmaxmin[1]) hmaxmin[1] = img[i];
        }
        OSSemPost(correctSDFSem);
    }
}

void correctSDF(void* p){
    int scale;
    int dim = *(int*)p;

    while(1){
        //printf("correctSDFSem pending\n");
	    OSSemPend(correctSDFSem, 0, &err);
        //printf("correctSDFSem run dim = %d\n", dim);
        if( correctAvg < 128){
            //printf("\e[0;32maverage=%d, ENABLE correntSDF\e[0m\n", correctAvg);
            scale = hmaxmin[0] - hmaxmin[1];
            if (scale < 128){
                if (scale > 63) scale = 1;
                else if (scale > 31) scale = 2;
                else if (scale > 15) scale = 3;
                else scale = 4;
                int i;
                for (i = 0; i < dim; i++){
                    img[i] = (img[i] - hmaxmin[1])<<scale;
                }
            }
        }else{
            //printf("\e[0;31maverage=%d, DISABLE correntSDF\e[0m\n", correctAvg);
        }

        correctSum += (hmaxmin[0] - hmaxmin[1]);
        correctAvg = correctSum/currentImg;
        OSSemPost(sobelSDFSem);
    }
}

void sobelSDF(void* p){
    DIM* dim = (DIM*)p;
    int dimX = dim->dimX;
    int dimY = dim->dimY;

    while(1){
        //printf("sobelSDFSem pending\n");
	    OSSemPend(sobelSDFSem, 0, &err);
        //printf("sobelSDFSem run\n");
        int gx = 0, gy = 0, res = 0, cur = dimX - 2;
        int i, j;
        for (i = 1; i < dimY - 1; i ++){
            cur += 2;
            for (j = 1; j < dimX - 1; j++){
                cur ++;
                gx = 0;
                gx -=   img[ cur - dimX - 1 ];
                gx +=   img[ cur - dimX + 1 ];
                gx -=   img[ cur        - 1 ]<<1;
                gx +=   img[ cur        + 1 ]<<1;
                gx -=   img[ cur + dimX - 1 ];
                gx +=   img[ cur + dimX + 1 ];
                gx=abs(gx)-1;
                gy = 0;
                gy -=   img[ cur - dimX - 1 ];
                gy -=   img[ cur - dimX     ]<<1;
                gy -=   img[ cur - dimX + 1 ];
                gy +=   img[ cur + dimX - 1 ];
                gy +=   img[ cur + dimX     ]<<1;
                gy +=   img[ cur + dimX + 1 ];
                
                res = fastsqrtdiv4(gx,gy);
                result[(i-1)*(dimX-2) + j-1] = res;
            }
        }
        get_time();
        printAscii(result, dimX-2, dimY-2);
        OSSemPost(graySDF2Sem);
    }
}
#ifdef __hal__
    void print_time(){
        int j;
        for (j = 1; j <= 5; j ++){
            D(printf("time #%d = %3.3g ms\n", j, (double)(time[j] - time[j-1]) * 1000 / alt_timestamp_freq()));
        }
        D(printf("Total time = %3.3g ms\n", (double)(time[5] - time[0]) * 1000 / alt_timestamp_freq()));
    }

#else
    #include <sys/time.h>
    struct timeval start_time, end_time[6];
    double timeuse;

    void start_timer(){
        gettimeofday(&start_time, 0);
        gettimeofday(&end_time[0],0);
    }

    void get_time(int i){
        gettimeofday(&end_time[i],0);
    }

    void print_time(){
        int j;
        for (j = 1; j <= 5; j ++){
            timeuse  = 1000000 * (end_time[j].tv_sec - end_time[j-1].tv_sec) + end_time[j].tv_usec - end_time[j-1].tv_usec;
            D(printf("time #%d = %3.3g ms\n", j, timeuse/1000));
        }
        timeuse  = 1000000 * (end_time[5].tv_sec - start_time.tv_sec) + end_time[5].tv_usec - start_time.tv_usec;
        D(printf("Total time = %3.3g ms\n", timeuse/1000));
    }
#endif


int main(){

    int dimX, dimY, dim1, dim3, dim4;
    DIM dim2, dim5;
    
    printf("Lab 1 RTOS");
    
    
    graySDF2Sem = OSSemCreate(0); 
    resizeSDF2Sem = OSSemCreate(0); 
    brightnessSigSem = OSSemCreate(0); 
    correctSDFSem = OSSemCreate(0); 
    sobelSDFSem = OSSemCreate(0); 

    OSStatInit();


    img = image_sequence[0];
    dimX = img[0];
    dimY = img[1];
    dim1 = dimX * dimY;
    dim2.dimX = dimX;
    dim2.dimY = dimY;
    dim3 = dim1>>2;
    dim4 = dim3;
    dim5.dimX = dimX>>1;
    dim5.dimY = dimY>>1;
    img += 3;

    err = OSTaskCreateExt(graySDF2,
                  &dim1,
                  (void *)&graySDF2_stk[TASK_STACKSIZE-1],
                  graySDF2_PRIO,
                  graySDF2_PRIO,
                  graySDF2_stk,
                  TASK_STACKSIZE,
                  NULL,
                  0);

    if (err == OS_ERR_NONE) { //if start successful
        D(printf("graySDF2 created\n"));
    }

    err = OSTaskCreateExt(resizeSDF2,
                  &dim2,
                  (void *)&resizeSDF2_stk[TASK_STACKSIZE-1],
                  resizeSDF2_PRIO,
                  resizeSDF2_PRIO,
                  resizeSDF2_stk,
                  TASK_STACKSIZE,
                  NULL,
                  0);

    if (err == OS_ERR_NONE) { //if start successful
        D(printf("resizeSDF2 created\n"));
    }

    err = OSTaskCreateExt(brightnessSig,
                  &dim3,
                  (void *)&brightnessSig_stk[TASK_STACKSIZE-1],
                  brightnessSig_PRIO,
                  brightnessSig_PRIO,
                  brightnessSig_stk,
                  TASK_STACKSIZE,
                  NULL,
                  0);

    if (err == OS_ERR_NONE) { //if start successful
        D(printf("brightnessSig created\n"));
    }
   
    err = OSTaskCreateExt(correctSDF,
                  &dim4,
                  (void *)&correctSDF_stk[TASK_STACKSIZE-1],
                  correctSDF_PRIO,
                  correctSDF_PRIO,
                  correctSDF_stk,
                  TASK_STACKSIZE,
                  NULL,
                  0);

    if (err == OS_ERR_NONE) { //if start successful
        D(printf("correctSDF created\n"));
    }

    err = OSTaskCreateExt(sobelSDF,
                  &dim5,
                  (void *)&sobelSDF_stk[TASK_STACKSIZE-1],
                  sobelSDF_PRIO,
                  sobelSDF_PRIO,
                  sobelSDF_stk,
                  TASK_STACKSIZE,
                  NULL,
                  0);

    if (err == OS_ERR_NONE) { //if start successful
        D(printf("sobelSDF created\n"));
    }

    printf("All Tasks and Kernel Objects generated!\n");
    OSSemPost(graySDF2Sem);
    printf("Start timing\n");
    OSStart();
    return 0;
}